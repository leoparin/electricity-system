<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.leo.electricitysystem.mapper.TicketMapper">

    <insert id="insertTicket" useGeneratedKeys="true">
        <selectKey keyProperty="ticketId" keyColumn="ticket_id" order="AFTER" resultType="Long">
            select last_insert_id()
        </selectKey>
       -- 插入操作票
        INSERT into operation_ticket(create_time,complete_time,task_name,admin_name,admin_id,worker_name,worker_id,supervisor_name,cabinet_id)
        VALUES (#{createTime},#{completeTime},#{taskName},#{adminName},#{adminId},#{workerName},#{workerId},#{supervisorName},#{cabinetId});
    </insert>

    <insert id="insertSteps" useGeneratedKeys="true">
        <selectKey  keyProperty="id"  keyColumn="id" order="AFTER" resultType="Long">
            select last_insert_id()
        </selectKey>
        -- 插入步骤
        INSERT into operation_steps(description,step_order,ticket_id,switch_id,switch_status)
        VALUES (#{description},#{stepOrder},#{ticketId},#{switchId},#{switchStatus})
    </insert>


    <select id="selectTicketPageByUserID" resultType="com.leo.electricitysystem.domain.OperationTicket">
        -- 根据用户id分页查询操作票（管理员，工人）
        SELECT * from operation_ticket
        <choose>
        <when test="loginUser.user.userType == '工人'">
            where #{loginUser.user.id} = worker_id
        </when>
        <otherwise>
            where #{loginUser.user.id} = admin_id
        </otherwise>
        </choose>
        LIMIT #{offset},#{pageSize};
    </select>

    <select id="selectTicketAmount" resultType="java.lang.Integer">
        -- 根据user类型以及id查看当前账户的ticket数目
        SELECT count(*) from operation_ticket
        <choose>
            <when test="loginUser.getUser().getUserType() == '工人'">
                where #{loginUser.user.id} = worker_id;
            </when>
            <otherwise>
                where #{loginUser.user.id} = admin_id;
            </otherwise>
        </choose>
    </select>


    <select id = "getTicketAmountByWorkerIdAndTime" resultType="java.lang.Integer">
        --   查询某个worker的全部操作票和错误操作票数目，并按照日期筛选
        SELECT count(*)
        from operation_ticket
        <choose>
            <when test = "statisticTransfer.userType == '工人'">
                where #{statisticTransfer.workerId} = worker_id
            </when>
            <otherwise>
                where #{statisticTransfer.workerId} = admin_id
            </otherwise>
        </choose>
        <if test=" statisticTransfer.status != null">
            and complete_status = #{statisticTransfer.status}
        </if>
          and DATE_SUB(CURRENT_DATE(),INTERVAL #{statisticTransfer.month} month) &lt;= create_time;
    </select>

    <select id="optionalSelect" resultType="com.leo.electricitysystem.domain.OperationTicket">
        -- 条件查询操作票
        select  *
        from operation_ticket
        <where>
            <if test = "dto.cabinetId != null">
                and #{dto.cabinetId} = cabinet_id
            </if>
            <if test = "dto.createTime != null">
                and #{dto.createTime} = create_time
            </if>
            <if test = "dto.completeTime != null">
                and #{dto.completeTime} = compelete_time
            </if>
            <if test = "dto.taskName != null">
                and #{dto.taskName} = task_name
            </if>
            <if test = "dto.workerId != null">
                and #{dto.workerId} = worker_id
            </if>
            <if test = "dto.supervisorName != null">
                and #{dto.supervisorName} = supervisor_name
            </if>
        </where>
    </select>
</mapper>